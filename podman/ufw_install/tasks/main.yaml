---
- name: Ensure UFW is installed
  apt:
    name: ufw
    state: present
    update_cache: true

- name: Allow defined ports through UFW
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto | default('tcp') }}"
    comment: "{{ item.comment | default('') }}"
  loop: "{{ ufw_allowed_ports }}"

- name: Check if UFW is active
  command: ufw status
  register: ufw_status
  changed_when: false

- name: Enable UFW (force, only if inactive)
  command: ufw --force enable
  when: "'inactive' in ufw_status.stdout"

- name: Set default deny incoming policy
  ufw:
    direction: incoming
    policy: deny

- name: Enable UFW logging
  ufw:
    logging: 'on'

- name: Restrict UFW to IPv4 only
  lineinfile:
    path: /etc/default/ufw
    regexp: '^IPV6='
    line: 'IPV6=no'
  notify: Restart UFW